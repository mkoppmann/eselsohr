name: FreeBSD

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-binary-for-freebsd:
    runs-on: macos-12

    env:
      CONFIG: "--disable-benchmarks --disable-documentation"

    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8

      - name: FreeBSD-VM
        id: build-freebsd
        uses: vmactions/freebsd-vm@08e4bc422b24209fb6d631c5755cdb4ec2e0b9f3
        with:
          release: 12.3
          envs: "CONFIG"
          usesh: true
          mem: 4096
          run: |
            # Switch to latest branch.
            mkdir -p /usr/local/etc/pkg/repos
            echo 'FreeBSD: { url: "pkg+https://pkg.FreeBSD.org/${ABI}/latest" }' > /usr/local/etc/pkg/repos/FreeBSD.conf
            pkg update

            # Install dependencies.
            # The GHC 8.10 port only contains the versioned ghc binary,
            # so we provide a symlink here because Cabal requires it.
            pkg install -y ghc810 hs-cabal-install
            ln -s /usr/local/bin/ghc-8.10.7 /usr/local/bin/ghc

            # Disable generation of documentation. Overriding this via cli
            # flags is broken.
            sed -i '.bak' 's/documentation: True/documentation: False/' cabal.project

            # Build and test project.
            cabal update
            cabal build $CONFIG all
            cabal test $CONFIG all
            cabal install --enable-executable-static --install-method=copy --overwrite-policy=always --installdir=dist/
            mv dist/eselsohr-exe dist/eselsohr

      - name: Store application binary as artifact
        uses: actions/upload-artifact@83fd05a356d7e2593de66fc9913b3002723633cb
        with:
          name: eselsohr
          path: dist/eselsohr
